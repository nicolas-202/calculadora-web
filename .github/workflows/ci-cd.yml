name: CI/CD para Calculadora Web

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Permite ejecución manual

env:
  PYTHON_VERSION: '3.9'
  PROJECT_NAME: 'calculadora-web-modular'

jobs:
  # Job de calidad de código y pruebas
  quality-checks:
    name: Linter y Pruebas Unitarias
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout del código
      uses: actions/checkout@v4
      
    - name: Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Instalar dependencias
      run: |
        python -m pip install --upgrade pip
        pip install pylint unittest-xml-reporting
        
    - name: Ejecutar pylint
      run: |
        pylint calculadora/ pruebas/ app.py --exit-zero --output-format=colorized
      continue-on-error: true  # El linter no bloquea el build
        
    - name: Ejecutar pruebas unitarias
      run: |
        python -m unittest discover -s pruebas -v
      
    - name: Generar reporte de pruebas (JUnit)
      run: |
        python -m unittest discover -s pruebas -p "test_*.py" -v 2>&1 | tee test-results.txt
        
    - name: Subir reporte de pruebas
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: test-results.txt
        retention-days: 7

  # Job de seguridad
  security-scan:
    name: Análisis de Seguridad
    runs-on: ubuntu-latest
    needs: quality-checks
    
    steps:
    - name: Checkout del código
      uses: actions/checkout@v4
      
    - name: Ejecutar Bandit (análisis de seguridad)
      run: |
        pip install bandit
        bandit -r calculadora/ -f html -o bandit-report.html || true
        bandit -r calculadora/ -f txt -o bandit-report.txt || true
        
    - name: Subir reporte de seguridad
      uses: actions/upload-artifact@v4
      with:
        name: security-reports
        path: |
          bandit-report.html
          bandit-report.txt
        retention-days: 7

  # Job de despliegue en Render
  deploy-render:
    name: Despliegue en Render
    runs-on: ubuntu-latest
    needs: [quality-checks, security-scan]
    
    # Solo ejecutar en pushes a main/master o manualmente
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout del código
      uses: actions/checkout@v4
      
    - name: Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Verificar estructura del proyecto
      run: |
        echo "Verificando estructura del proyecto..."
        ls -la
        echo "--- calculadora/ ---"
        ls -la calculadora/
        echo "--- pruebas/ ---"
        ls -la pruebas/
        echo "--- static/ ---"
        ls -la static/
        echo "--- templates/ ---"
        ls -la templates/
        
    - name: Ejecutar pruebas finales
      run: |
        python -m unittest pruebas/test_operaciones.py -v
        
    - name: Desplegar en Render
      run: echo "Este paso está comentariado"
      #uses: johnbeynon/render-deploy-action@v0.0.8
      #with:
        #service-id: ${{ secrets.RENDER_SERVICE_ID }}
        #api-key: ${{ secrets.RENDER_API_KEY }}
        
    - name: Verificar despliegue
      run: |
        echo "Despliegue iniciado en Render"
        echo "El servicio debería estar disponible en breve"
        
  # Job de notificaciones
  notifications:
    name: Notificaciones
    runs-on: ubuntu-latest
    needs: [quality-checks, security-scan, deploy-render]
    if: always()  # Siempre ejecutar, incluso si fallan otros jobs
    
    steps:
    - name: Notificar resultado
      run: |
        echo "Workflow completado - Revisa los resultados anteriores"
        echo "Event: ${{ github.event_name }}"
        echo "Ref: ${{ github.ref }}"
        echo "SHA: ${{ github.sha }}"
